"""Gemini APIã«ã‚ˆã‚‹å­—å¹•è¦ç´„ã‚µãƒ¼ãƒ“ã‚¹"""

from google import genai

from config import Config

# è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
SUMMARY_PROMPT = """ã‚ãªãŸã¯YouTubeå‹•ç”»ã®å†…å®¹ã‚’æ­£ç¢ºã‹ã¤ç°¡æ½”ã«è¦ç´„ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®YouTubeå‹•ç”»ã®å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æã—ã€æ—¥æœ¬èªã§ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å³å¯†ã«å¾“ã£ã¦è¦ç´„ã—ã¦ãã ã•ã„ã€‚

ã€æ¦‚è¦ã€‘
ï¼ˆ140æ–‡å­—ç¨‹åº¦ã§å‹•ç”»ã®å†…å®¹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ï¼‰

ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã€‘
ãƒ»ãƒã‚¤ãƒ³ãƒˆ1
ãƒ»ãƒã‚¤ãƒ³ãƒˆ2
ãƒ»ãƒã‚¤ãƒ³ãƒˆ3

ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ /çµè«–ã€‘
ï¼ˆè¦–è´è€…ãŒå–ã‚‹ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚„å‹•ç”»ã®çµè«–ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ï¼‰

---
ä»¥ä¸‹ãŒå­—å¹•ãƒ†ã‚­ã‚¹ãƒˆã§ã™:

{transcript}
"""


def summarize_transcript(transcript: str) -> str:
    """å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆã‚’Gemini APIã§è¦ç´„ã™ã‚‹ã€‚

    Args:
        transcript: YouTubeå‹•ç”»ã®å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆã€‚

    Returns:
        ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸè¦ç´„ãƒ†ã‚­ã‚¹ãƒˆã€‚
    """
    client = genai.Client(api_key=Config.GEMINI_API_KEY)

    # å­—å¹•ãŒé•·ã™ãã‚‹å ´åˆã¯å…ˆé ­ã‚’åˆ‡ã‚Šè©°ã‚ã‚‹ï¼ˆGemini 2.0 Flashã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸Šé™è€ƒæ…®ï¼‰
    max_chars = 100_000
    if len(transcript) > max_chars:
        transcript = transcript[:max_chars]
        transcript += "\n\nï¼ˆâ€»å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã„ãŸã‚ã€é€”ä¸­ã¾ã§ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼‰"

    prompt = SUMMARY_PROMPT.format(transcript=transcript)

    response = client.models.generate_content(
        model="gemini-3-flash-preview",
        contents=prompt,
    )

    return response.text


# ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆï¼ˆæ—¥åˆŠã¾ã¨ã‚ï¼‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
DIGEST_PROMPT = """ã‚ãªãŸã¯æœ€æ–°ã®AIãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼æƒ…å ±ã‚’ã‚ã‹ã‚Šã‚„ã™ãã¾ã¨ã‚ã‚‹å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®è¤‡æ•°ã®å‹•ç”»è¦ç´„ã‚’èª­ã¿ã€ã€Œæœ¬æ—¥ã®æœ€æ–°ãƒˆãƒ”ãƒƒã‚¯ã€ã¨ã—ã¦
å‹äººã‚„çŸ¥äººã«å…±æœ‰ã™ã‚‹ãŸã‚ã®ã€èª­ã¿ã‚„ã™ã„ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€å³å®ˆãƒ«ãƒ¼ãƒ«ã€‘
- æƒ…å ±æºï¼ˆãƒãƒ£ãƒ³ãƒãƒ«åã€YouTubeã€å‹•ç”»ãªã©ï¼‰ã«ã¯ä¸€åˆ‡è¨€åŠã—ãªã„ã“ã¨
- ã€ŒNotionã«ä¿å­˜ã—ã¾ã—ãŸã€ã€Œã¾ã¨ã‚ã¾ã—ãŸã€ç­‰ã®ã‚·ã‚¹ãƒ†ãƒ å ±å‘Šã¯æ›¸ã‹ãªã„ã“ã¨
- ã‚ãŸã‹ã‚‚è‡ªåˆ†ã§æœ€æ–°æƒ…å ±ã‚’é›†ã‚ã¦ã¾ã¨ã‚ãŸã‹ã®ã‚ˆã†ãªè‡ªç„¶ãªãƒˆãƒ¼ãƒ³ã§æ›¸ãã“ã¨
- ãƒˆãƒ”ãƒƒã‚¯ã”ã¨ã«ç•ªå·ï¼ˆâ‘ â‘¡â‘¢...ï¼‰ä»˜ãã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹ã“ã¨
- å„ãƒˆãƒ”ãƒƒã‚¯ã¯2ã€œ3è¡Œç¨‹åº¦ã§è¦ç‚¹ã ã‘ä¼ãˆã‚‹ã“ã¨
- æœ€å¾Œã«è¦ªã—ã¿ã®ã‚ã‚‹ä¸€è¨€ï¼ˆã€Œæ°—ã«ãªã‚‹ã‚‚ã®ãŒã‚ã‚Œã°èã„ã¦ã­ï¼ã€ç­‰ï¼‰ã‚’æ·»ãˆã‚‹ã“ã¨
- å…¨ä½“ã§1000æ–‡å­—ä»¥å†…ã«åã‚ã‚‹ã“ã¨

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ğŸ“° ï¼ˆæœ¬æ—¥ã®æ—¥ä»˜ï¼‰ AIãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼æœ€æ–°ãƒˆãƒ”ãƒƒã‚¯

â‘  ï¼ˆãƒˆãƒ”ãƒƒã‚¯åï¼‰
ï¼ˆ2ã€œ3è¡Œã®èª¬æ˜ï¼‰

â‘¡ ï¼ˆãƒˆãƒ”ãƒƒã‚¯åï¼‰
ï¼ˆ2ã€œ3è¡Œã®èª¬æ˜ï¼‰

ğŸ’¡ ï¼ˆè¦ªã—ã¿ã®ã‚ã‚‹ä¸€è¨€ï¼‰

---
ä»¥ä¸‹ãŒå„å‹•ç”»ã®è¦ç´„ã§ã™:

{summaries}
"""


def generate_daily_digest(summaries: list[dict]) -> str:
    """è¤‡æ•°ã®å‹•ç”»è¦ç´„ã‹ã‚‰æ—¥åˆŠãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚

    Args:
        summaries: å‹•ç”»è¦ç´„ã®ãƒªã‚¹ãƒˆã€‚å„è¦ç´ ã¯ {{"title": str, "summary": str}}ã€‚

    Returns:
        æ—¥åˆŠãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆã€‚
    """
    client = genai.Client(api_key=Config.GEMINI_API_KEY)

    # è¦ç´„ã‚’é€£çµ
    combined = ""
    for i, s in enumerate(summaries, 1):
        combined += f"--- å‹•ç”»{i}: {s['title']} ---\n{s['summary']}\n\n"

    prompt = DIGEST_PROMPT.format(summaries=combined)

    response = client.models.generate_content(
        model="gemini-3-flash-preview",
        contents=prompt,
    )

    return response.text
